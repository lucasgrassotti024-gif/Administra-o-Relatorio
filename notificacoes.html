<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Notifica√ß√µes ‚Äî Sistema RSS3</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Outfit:wght@600;800&display=swap" rel="stylesheet">

<style>
:root {
  --primary:#2563eb;
  --accent:#1d4ed8;
  --bg:#f3f6fb;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --shadow-soft:0 10px 30px rgba(15,23,42,0.10);
  --shadow-hard:0 18px 45px rgba(15,23,42,0.20);
  --sidebar-bg:#ffffff;
  --sidebar-text:#111827;
  --sidebar-link:#111827;
  --danger: #ef4444;
  --success: #10b981;
}
.dark {
  --bg:#020617;
  --card:#0b1120;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --border:#1e293b;
  --shadow-soft:0 10px 30px rgba(0,0,0,0.60);
  --shadow-hard:0 18px 45px rgba(0,0,0,0.80);
  --sidebar-bg:#020617;
  --sidebar-text:#e5e7eb;
  --sidebar-link:#e5e7eb;
}

*{ box-sizing:border-box; font-family:"Inter",sans-serif; transition:background-color .25s ease, color .25s ease; }

body{ margin:0; background:var(--bg); color:var(--text); min-height:100vh; display:flex; }

/* SIDEBAR */
.sidebar{
  width:230px; background:var(--sidebar-bg); color:var(--sidebar-text);
  display:flex; flex-direction:column; padding:14px 12px; gap:14px;
  position:fixed; inset-block:0; left:0; z-index:40;
  box-shadow:var(--shadow-hard); transform:translateX(-100%); transition:transform .25s ease;
}
body.sidebar-open .sidebar{ transform:translateX(0); }

.sidebar-header{ display:flex; align-items:center; justify-content:space-between; }
.sidebar-title{ font-family:"Outfit"; font-weight:800; font-size:1.0rem; }
.sidebar-sub{ font-size:.72rem; color:var(--muted); }

.sidebar-toggle-theme{
  width:32px; height:32px; border-radius:50%; border:1px solid rgba(148,163,184,0.5);
  display:flex; align-items:center; justify-content:center; cursor:pointer;
  background:transparent; color:var(--sidebar-text); font-size: 1rem;
}

.sidebar-nav{ display:flex; flex-direction:column; gap:4px; }
.sidebar-link{
  display:flex; align-items:center; gap:8px; padding:8px 9px; border-radius:10px;
  text-decoration:none; font-size:.85rem; color:var(--sidebar-link);
}
.sidebar-link.active{ background:rgba(37,99,235,0.15); font-weight: 600; }
.sidebar-link:hover:not(.active) { background:rgba(37,99,235,0.05); }

.sidebar-handle{
  position:fixed; top:14px; left:10px; z-index:45; width:30px; height:30px;
  border-radius:999px; border:none; cursor:pointer; background:#2563eb; color:#f9fafb;
  box-shadow:0 8px 20px rgba(37,99,235,0.6); display:flex; align-items:center; justify-content:center;
}

/* MAIN CONTENT */
.main-wrapper{ flex:1; padding:18px 20px; display:flex; flex-direction:column; max-width: 1200px; margin: 0 auto; }
@media(max-width:900px){ .main-wrapper{ padding-top:56px; } }

.page-header{ margin-bottom:25px; display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 15px; }
.page-title{ font-family:"Outfit"; font-weight:800; font-size:1.4rem; }

/* CONTROLES E STATS */
.controls { display: flex; gap: 10px; align-items: center; }
input[type="date"] { 
    padding: 8px; border-radius: 8px; border: 1px solid var(--border); 
    background: var(--card); color: var(--text); font-size: 0.9rem;
}

.stats-grid { 
    display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
    gap: 15px; margin-bottom: 25px; 
}
.stat-card { 
    background: var(--card); padding: 15px; border-radius: 12px; 
    border: 1px solid var(--border); text-align: center;
}
.stat-card span { display: block; font-size: 0.75rem; color: var(--muted); text-transform: uppercase; margin-bottom: 5px; }
.stat-card b { font-size: 1.4rem; color: var(--primary); }

/* NOTIFICA√á√ïES */
.notif-list { display: flex; flex-direction: column; gap: 12px; }
.card-notif {
  background: var(--card); padding: 16px; border-radius: 14px;
  border: 1px solid var(--border); border-left: 6px solid var(--primary);
  box-shadow: var(--shadow-soft); display: flex; align-items: center; gap: 15px;
  position: relative; animation: slideIn 0.3s ease-out;
}
@keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.card-notif.urgente { border-left-color: var(--danger); }
.btn-excluir {
  position: absolute; top: 10px; right: 10px; background: transparent;
  border: none; color: var(--muted); cursor: pointer; font-size: 1.2rem;
}
.btn-excluir:hover { color: var(--danger); }

.notif-icon { font-size: 1.5rem; }
.notif-info b { display: block; font-size: 1.05rem; margin-bottom: 4px; color: var(--primary); }
.card-notif.urgente b { color: var(--danger); }
.notif-info p { margin: 0; font-size: 0.9rem; color: var(--text); line-height: 1.4; }
.notif-info span { font-size: 0.75rem; color: var(--muted); margin-top: 8px; display: block; }

footer{ margin-top:auto; font-size:.75rem; color:var(--muted); text-align:center; padding: 20px; }
</style>
</head>
<body class="sidebar-open">

<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-title-block">
      <span class="sidebar-title">Relat√≥rios de Campo</span>
      <span class="sidebar-sub">CMPC ‚Ä¢ RSS3</span>
    </div>
    <button id="themeToggle" class="sidebar-toggle-theme" type="button">üåô</button>
  </div>

  <nav class="sidebar-nav">
    <a href="admin.html" class="sidebar-link"><span class="icon">üìã</span><span>Admin</span></a>
    <a href="dashboard.html" class="sidebar-link"><span class="icon">üìä</span><span>Dashboard</span></a>
    <a href="planilha.html" class="sidebar-link"><span class="icon">üìë</span><span>Planilha</span></a>
    <a href="oleo-ibcs.html" class="sidebar-link"><span class="icon">üõ¢Ô∏è</span><span>√ìleo em IBCs</span></a>
    <a href="notificacoes.html" class="sidebar-link active"><span class="icon">üîî</span><span>Notifica√ß√µes</span></a>
    <a href="excluidos.html" class="sidebar-link"><span class="icon">üóëÔ∏è</span><span>Exclu√≠dos</span></a>
  </nav>
</aside>

<button id="sidebarHandle" class="sidebar-handle" type="button">‚ò∞</button>

<div class="main-wrapper">
  <header class="page-header">
    <div>
        <div class="page-title">Centro de Notifica√ß√µes</div>
        <div class="sidebar-sub" id="statusVerificacao">Sincronizando...</div>
    </div>
    <div class="controls">
        <input type="date" id="dataFiltro">
        <button onclick="verificarPendenciasReal()" style="cursor:pointer; background:var(--primary); color:white; border:none; padding:8px 12px; border-radius:8px; font-size:0.8rem;">üîÑ Atualizar</button>
    </div>
  </header>

  <div class="stats-grid">
    <div class="stat-card"><span>Relat√≥rios Enviados</span><b id="statEnviados">0</b></div>
    <div class="stat-card"><span>Pend√™ncias</span><b id="statPendencias" style="color:var(--danger)">0</b></div>
    <div class="stat-card"><span>Data Analisada</span><b id="statData" style="font-size:1rem; color:var(--text)">--/--</b></div>
  </div>

  <div class="notif-list" id="listaNotificacoes"></div>

  <footer>¬© 2025 | Sistema RSS3 - Gest√£o de Res√≠duos</footer>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCAfBANhkMec6TCGCO9JwrvOB79RbyLw8I",
  authDomain: "relatorio-rss3-15896.firebaseapp.com",
  projectId: "relatorio-rss3-15896",
  storageBucket: "relatorio-rss3-15896.firebasestorage.app",
  messagingSenderId: "905086909082",
  appId: "1:905086909082:web:7535afa8dddbd7b691fd23"
};
if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
const db = firebase.firestore();

/* TEMA E SIDEBAR */
const themeToggle = document.getElementById("themeToggle");
const sidebarHandle = document.getElementById("sidebarHandle");
if(localStorage.getItem("tema") === "dark"){ document.body.classList.add("dark"); themeToggle.textContent = "‚òÄÔ∏è"; }
themeToggle.onclick = () => {
  document.body.classList.toggle("dark");
  const isDark = document.body.classList.contains("dark");
  themeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("tema", isDark ? "dark" : "light");
};
sidebarHandle.onclick = () => document.body.classList.toggle("sidebar-open");

/* MONITORAMENTO */
const TURNOS_CONFIG = [
    { id: "t1", nome: "Turno 1", inicio: "07:30", fim: "14:40", icone: "‚òÄÔ∏è" },
    { id: "t2", nome: "Turno 2", inicio: "14:40", fim: "23:40", icone: "üåÜ" },
    { id: "t3", nome: "Turno 3", inicio: "23:40", fim: "07:30", icone: "üåô" }
];
const OPERADORES_ADM = ["Bruno Ramos", "Carlos Alexandre"];

// Define data padr√£o como ontem
const inputData = document.getElementById("dataFiltro");
const ontem = new Date();
ontem.setDate(ontem.getDate() - 1);
inputData.value = ontem.toISOString().split('T')[0];

async function verificarPendenciasReal() {
    const lista = document.getElementById("listaNotificacoes");
    const status = document.getElementById("statusVerificacao");
    const dataBusca = inputData.value;
    const dataFormatada = dataBusca.split('-').reverse().join('/');
    
    // Recupera notifica√ß√µes ignoradas do LocalStorage
    const ignoradas = JSON.parse(localStorage.getItem('notif_ignoradas') || "[]");

    lista.innerHTML = "<p style='text-align:center;'>Buscando dados...</p>";
    document.getElementById("statData").textContent = dataFormatada;

    try {
        const querySnapshot = await db.collection("relatoriosCampo")
            .where("data", "==", dataBusca)
            .get();

        const relatorios = querySnapshot.docs.map(doc => doc.data());
        lista.innerHTML = "";
        let pendenciasCount = 0;

        // 1. Verifica√ß√£o ADM
        const dataObj = new Date(dataBusca + "T12:00:00");
        const diaSemana = dataObj.getDay(); 
        if (diaSemana >= 1 && diaSemana <= 5) {
            OPERADORES_ADM.forEach(adm => {
                const idNotif = `adm-${adm}-${dataBusca}`;
                if (ignoradas.includes(idNotif)) return;

                if (!relatorios.some(r => r.operador === adm)) {
                    gerarCard(idNotif, `ADM: ${adm}`, `Relat√≥rio individual n√£o enviado.`, "üë§", "urgente");
                    pendenciasCount++;
                }
            });
        }

        // 2. Verifica√ß√£o de Turnos
        TURNOS_CONFIG.forEach(turno => {
            const idNotif = `turno-${turno.id}-${dataBusca}`;
            if (ignoradas.includes(idNotif)) return;

            const coberto = relatorios.some(r => {
                const h = r.horario || r.horaInicio || r.horarios?.inicio || "00:00";
                return validarHorarioTurno(h, turno.inicio, turno.fim);
            });

            if (!coberto) {
                gerarCard(idNotif, `Cobertura: ${turno.nome}`, `Sem registros entre ${turno.inicio} e ${turno.fim}.`, turno.icone, "urgente");
                pendenciasCount++;
            }
        });

        // Atualiza Stats
        document.getElementById("statEnviados").textContent = relatorios.length;
        document.getElementById("statPendencias").textContent = pendenciasCount;
        status.textContent = "Sincronizado";

        if (pendenciasCount === 0) {
            lista.innerHTML = `<div style="text-align:center; padding:40px; color:var(--muted);">‚úÖ Tudo em dia para este dia!</div>`;
        }

    } catch (e) {
        status.textContent = "Erro de conex√£o";
        console.error(e);
    }
}

function validarHorarioTurno(h, inicio, fim) {
    const hora = h.substring(0,5);
    return inicio < fim ? (hora >= inicio && hora < fim) : (hora >= inicio || hora < fim);
}

function gerarCard(id, titulo, msg, icone, classe) {
    const card = document.createElement("div");
    card.className = `card-notif ${classe}`;
    card.innerHTML = `
        <button class="btn-excluir" onclick="ignorarNotificacao('${id}', this)">&times;</button>
        <div class="notif-icon">${icone}</div>
        <div class="notif-info">
            <b>${titulo}</b>
            <p>${msg}</p>
            <span>Verifica√ß√£o Autom√°tica RSS3</span>
        </div>
    `;
    document.getElementById("listaNotificacoes").appendChild(card);
}

function ignorarNotificacao(id, btn) {
    const ignoradas = JSON.parse(localStorage.getItem('notif_ignoradas') || "[]");
    ignoradas.push(id);
    localStorage.setItem('notif_ignoradas', JSON.stringify(ignoradas));
    
    const card = btn.closest('.card-notif');
    card.style.opacity = '0';
    setTimeout(() => { 
        card.remove();
        const atual = parseInt(document.getElementById("statPendencias").textContent);
        document.getElementById("statPendencias").textContent = Math.max(0, atual - 1);
    }, 300);
}

inputData.onchange = verificarPendenciasReal;
verificarPendenciasReal();
</script>
</body>
</html>
