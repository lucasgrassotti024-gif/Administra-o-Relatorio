<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard ‚Äî Relat√≥rios de Campo</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Outfit:wght@600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --primary:#2563eb;
  --accent:#1d4ed8;
  --bg:#f3f6fb;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --shadow-soft:0 10px 30px rgba(15,23,42,0.10);
  --shadow-hard:0 18px 45px rgba(15,23,42,0.20);

  --sidebar-bg:#ffffff;
  --sidebar-text:#111827;
  --sidebar-link:#111827;
}
.dark {
  --bg:#020617;
  --card:#020617;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --border:#111827;
  --shadow-soft:0 10px 30px rgba(0,0,0,0.60);
  --shadow-hard:0 18px 45px rgba(0,0,0,0.80);

  --sidebar-bg:#020617;
  --sidebar-text:#e5e7eb;
  --sidebar-link:#e5e7eb;
}

*{
  box-sizing:border-box;
  font-family:"Inter",sans-serif;
  transition:background-color .25s ease,color .25s ease,border-color .25s ease;
}

/* FUNDO */
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  display:flex;
}

/* SIDEBAR */
.sidebar{
  width:230px;
  background:var(--sidebar-bg);
  color:var(--sidebar-text);
  display:flex;
  flex-direction:column;
  padding:14px 12px;
  gap:14px;
  position:fixed;
  inset-block:0;
  left:0;
  z-index:40;
  box-shadow:var(--shadow-hard);
  transition:transform .25s ease, background-color .25s ease, color .25s ease;
}
.sidebar-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.sidebar-title-block{
  display:flex;
  flex-direction:column;
}
.sidebar-title{
  font-family:"Outfit";
  font-weight:800;
  font-size:1.0rem;
}
.sidebar-sub{
  font-size:.72rem;
  color:var(--muted);
}
.sidebar-toggle-theme{
  width:32px;
  height:32px;
  border-radius:50%;
  border:1px solid rgba(148,163,184,0.5);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  background:transparent;
  font-size:1rem;
  color:var(--sidebar-text);
}
.sidebar-nav{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.sidebar-link{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 9px;
  border-radius:10px;
  text-decoration:none;
  font-size:.85rem;
  color:var(--sidebar-link);
  cursor:pointer;
}
.sidebar-link span.icon{width:18px;text-align:center;}
.sidebar-link:hover,
.sidebar-link.active{
  background:rgba(37,99,235,0.15);
}
.sidebar-footer{
  margin-top:auto;
  font-size:.7rem;
  color:var(--muted);
  border-top:1px solid rgba(148,163,184,0.3);
  padding-top:8px;
}

/* SIDEBAR ABRE/FECHA COMO OVERLAY (conte√∫do n√£o anda) */
.sidebar{
  transform:translateX(-100%);
}
body.sidebar-open .sidebar{
  transform:translateX(0);
}

/* BOT√ÉO FLOANTE SIDEBAR */
.sidebar-handle{
  position:fixed;
  top:14px;
  left:10px;
  z-index:45;
  width:30px;
  height:30px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  background:#2563eb;
  color:#f9fafb;
  box-shadow:0 8px 20px rgba(37,99,235,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.1rem;
}

/* MAIN WRAPPER */
.main-wrapper{
  flex:1;
  min-height:100vh;
  padding:18px 20px 24px;
  display:flex;
  flex-direction:column;
}
@media(max-width:900px){
  .main-wrapper{
    padding-top:56px;
  }
}

/* TOPBAR MOBILE */
.topbar-mobile{
  position:fixed;
  top:0;left:0;right:0;
  height:48px;
  background:var(--sidebar-bg);
  color:var(--sidebar-text);
  display:flex;
  align-items:center;
  justify-content:center;
  font-family:"Outfit";
  font-weight:700;
  font-size:.9rem;
  z-index:30;
}
@media(min-width:901px){
  .topbar-mobile{display:none;}
}

/* HEADER DASHBOARD */
.dashboard-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:12px;
  margin-bottom:10px;
}
.dashboard-title{
  font-family:"Outfit";
  font-weight:800;
  font-size:1.4rem;
}
.tag-periodo{
  padding:4px 8px;
  border-radius:999px;
  background:rgba(15,23,42,0.06);
  font-size:.75rem;
  color:var(--muted);
}

/* FILTROS */
.filters{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:10px;
}
.filter-chip{
  display:flex;
  flex-direction:column;
  font-size:.75rem;
  color:var(--muted);
  gap:2px;
}
.filter-chip select{
  min-width:110px;
  padding:6px 9px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--card);
  font-size:.8rem;
  color:var(--text);
  outline:none;
}

/* MULTI SELECT LOCAL (estilo Excel) */
.multi-select{
  position:relative;
}
#btnLocal{
  min-width:150px;
  padding:6px 9px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  font-size:.8rem;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.multi-panel{
  position:absolute;
  top:110%;
  left:0;
  min-width:220px;
  background:var(--card);
  border-radius:10px;
  border:1px solid var(--border);
  box-shadow:var(--shadow-soft);
  padding:8px;
  display:none;
  z-index:50;
}
.multi-panel.open{
  display:block;
}
.multi-panel-inner{
  max-height:210px;
  overflow:auto;
  margin-bottom:6px;
}
.multi-option{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:.8rem;
  padding:2px 0;
}
.multi-option input{
  width:14px;
  height:14px;
}
#applyLocal{
  width:100%;
  padding:5px 8px;
  border-radius:8px;
  border:none;
  background:linear-gradient(135deg,#2563eb,#1d4ed8);
  color:#f9fafb;
  font-size:.78rem;
  font-weight:600;
  cursor:pointer;
}

/* CARDS KPIs (centralizados) */
.kpi-row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:12px;
}
.kpi-card{
  flex:1;
  min-width:160px;
  border-radius:14px;
  padding:10px 10px;
  background:linear-gradient(135deg,#2563eb,#1d4ed8);
  color:#f9fafb;
  box-shadow:var(--shadow-hard);
  display:flex;
  flex-direction:column;
  gap:4px;
  align-items:center;
  text-align:center;
}
.kpi-label{
  font-size:.72rem;
  text-transform:uppercase;
  letter-spacing:.09em;
  opacity:.9;
}
.kpi-value{
  font-family:"Outfit";
  font-size:1.2rem;
  font-weight:800;
}

/* COLUNA DE GR√ÅFICOS */
.charts-column{
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* CARD DE GR√ÅFICO */
.card-surface{
  background:var(--card);
  border-radius:18px;
  padding:10px 12px 14px;
  box-shadow:var(--shadow-soft);
  border:1px solid rgba(148,163,184,0.2);
}
.card-surface h3{
  margin:0 0 4px;
  font-size:.9rem;
  font-weight:700;
}

/* LAYOUT DOS GR√ÅFICOS */
.chart-wrap{
  position:relative;
  width:100%;
  height:200px;
}
.chart-wrap-top{
  height:260px;
}
.charts-bottom{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
@media(max-width:900px){
  .chart-wrap-top{height:230px;}
  .charts-bottom{
    grid-template-columns:1fr;
  }
  .chart-wrap{height:220px;}
}

/* MINI SUMMARY */
.mini-summary{
  margin-top:6px;
  font-size:.75rem;
  color:var(--muted);
}

/* FOOTER */
footer{
  margin-top:16px;
  font-size:.75rem;
  color:var(--muted);
  text-align:center;
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-title-block">
      <span class="sidebar-title">Relat√≥rios de Campo</span>
      <span class="sidebar-sub">CMPC ‚Ä¢ RSS3</span>
    </div>
    <button id="themeToggle" class="sidebar-toggle-theme" type="button">üåô</button>
  </div>

  <nav class="sidebar-nav">
    <a href="admin.html" class="sidebar-link">
      <span class="icon">üìã</span><span>Admin</span>
    </a>
    <a href="dashboard.html" class="sidebar-link active">
      <span class="icon">üìä</span><span>Dashboard</span>
    </a>
    <a href="planilha.html" class="sidebar-link">
      <span class="icon">üìë</span><span>Planilha</span>
    </a>
    <a href="oleo-ibcs.html" class="sidebar-link">
      <span class="icon">üõ¢Ô∏è</span><span>√ìleo em IBCs</span>
    </a>
    <a href="excluidos.html" class="sidebar-link">
      <span class="icon">üóëÔ∏è</span><span>Exclu√≠dos</span>
    </a>
  </nav>

  <div class="sidebar-footer">
    Vis√£o consolidada de atividades,<br>tempos e caminh√µes.
  </div>
</aside>

<button id="sidebarHandle" class="sidebar-handle" type="button">‚ò∞</button>

<div class="topbar-mobile">Dashboard ‚Äî Relat√≥rios</div>

<!-- MAIN -->
<div class="main-wrapper">
  <header class="dashboard-header">
    <div class="dashboard-title">Dashboard de Atividades</div>
    <!-- Tag de per√≠odo agora come√ßa vazia, sem frase "M√™s: todos ‚Äî ..." -->
    <div class="tag-periodo" id="tagPeriodo"></div>
  </header>

  <!-- FILTROS -->
  <div class="filters">
    <div class="filter-chip">
      <span>M√™s</span>
      <select id="filtroMes">
        <option value="">Todos</option>
        <option value="01">Jan</option>
        <option value="02">Fev</option>
        <option value="03">Mar</option>
        <option value="04">Abr</option>
        <option value="05">Mai</option>
        <option value="06">Jun</option>
        <option value="07">Jul</option>
        <option value="08">Ago</option>
        <option value="09">Set</option>
        <option value="10">Out</option>
        <option value="11">Nov</option>
        <option value="12">Dez</option>
      </select>
    </div>

    <div class="filter-chip">
      <span>Local</span>
      <div class="multi-select">
        <button type="button" id="btnLocal">
          <span id="btnLocalText">Todos os locais</span>
          <span>‚ñæ</span>
        </button>
        <div class="multi-panel" id="panelLocal">
          <div class="multi-panel-inner" id="panelLocalList">
            <!-- op√ß√µes de locais (preenchido via JS) -->
          </div>
          <button type="button" id="applyLocal">Aplicar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CARDS KPIs -->
  <div class="kpi-row">
    <div class="kpi-card">
      <span class="kpi-label">Total de Atividades</span>
      <span class="kpi-value" id="kpiAtividades">0</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">Tempo Trabalhando</span>
      <span class="kpi-value" id="kpiTrabalhando">00:00</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">DDS & Checklist</span>
      <span class="kpi-value" id="kpiDDS">00:00</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">Tempo de Espera</span>
      <span class="kpi-value" id="kpiEspera">00:00</span>
    </div>
  </div>

  <!-- GR√ÅFICOS -->
  <section class="charts-column">
    <!-- TOPO: √ÅREAS -->
    <div class="card-surface">
      <h3>Atividades por √Årea / Local</h3>
      <div class="chart-wrap chart-wrap-top">
        <canvas id="chartArea"></canvas>
      </div>
    </div>

    <!-- BAIXO: ESQUERDA + DIREITA -->
    <div class="charts-bottom">
      <div class="card-surface">
        <h3>Tempo Trabalhado por Caminh√£o</h3>
        <div class="chart-wrap">
          <canvas id="chartTempoCaminhao"></canvas>
        </div>
      </div>

      <div class="card-surface">
        <h3>Atividades por Caminh√£o</h3>
        <div class="chart-wrap">
          <canvas id="chartCaminhao"></canvas>
        </div>
      </div>
    </div>

    <div class="mini-summary" id="miniSummary">
      Carregando estat√≠sticas...
    </div>
  </section>

  <footer>
    ¬© 2025 | Relat√≥rios de Campo ‚Äî Dashboard
  </footer>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCxI5gx0LS0ny2y6UnPUCyW0zf1BjnTSco",
  authDomain: "checklist-rss3.firebaseapp.com",
  projectId: "checklist-rss3",
  storageBucket: "checklist-rss3.appspot.com",
  messagingSenderId: "179261205524",
  appId: "1:179261205524:web:376152c3b94fb115f14b01",
  measurementId: "G-47CPMQ3ZTC"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<script>
// Prote√ß√£o b√°sica (se n√£o quiser, s√≥ comentar o redirect)
if(localStorage.getItem("auth_relatorios")!=="true"){
  // window.location.href="index.html";
}

/* Tema */
const themeToggle=document.getElementById("themeToggle");
if(localStorage.getItem("tema")==="dark"){
  document.body.classList.add("dark");
  themeToggle.textContent="‚òÄÔ∏è";
}
themeToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  const dark=document.body.classList.contains("dark");
  themeToggle.textContent=dark?"‚òÄÔ∏è":"üåô";
  localStorage.setItem("tema",dark?"dark":"light");
};

/* Sidebar abre/fecha (overlay, conte√∫do n√£o se mexe) */
const sidebarHandle=document.getElementById("sidebarHandle");
sidebarHandle.addEventListener("click",()=>{
  document.body.classList.toggle("sidebar-open");
});
</script>

<script>
let relatorios = [];
let filtrados = [];
let locaisDisponiveis = [];
let locaisSelecionados = new Set();

// Filtros
const filtroMesEl=document.getElementById("filtroMes");
const btnLocal=document.getElementById("btnLocal");
const btnLocalText=document.getElementById("btnLocalText");
const panelLocal=document.getElementById("panelLocal");
const panelLocalList=document.getElementById("panelLocalList");
const applyLocalBtn=document.getElementById("applyLocal");
const tagPeriodo=document.getElementById("tagPeriodo");
const miniSummaryEl=document.getElementById("miniSummary");

// KPIs
const kpiAtividades=document.getElementById("kpiAtividades");
const kpiTrabalhando=document.getElementById("kpiTrabalhando");
const kpiDDS=document.getElementById("kpiDDS");
const kpiEspera=document.getElementById("kpiEspera");

// Charts
let chartArea=null;
let chartCaminhao=null;
let chartTempoCaminhao=null;

/* ===== Helpers de tempo ===== */
function parseTimeToMinutes(str){
  if(!str) return null;
  const parts=str.split(":");
  if(parts.length<2) return null;
  const h=parseInt(parts[0],10);
  const m=parseInt(parts[1],10);
  if(isNaN(h)||isNaN(m)) return null;
  return h*60+m;
}
function diffMinutes(a,b){
  const ma=parseTimeToMinutes(a);
  const mb=parseTimeToMinutes(b);
  if(ma==null || mb==null) return null;
  const diff=mb-ma;
  if(diff<=0) return null;
  return diff;
}
/* üîπ Novo formato HH:MM para tudo (KPIs e gr√°fico de tempo por caminh√£o) */
function formatMinutesAsHhMm(min){
  if(!min || min<=0) return "00:00";
  const h=Math.floor(min/60);
  const m=min%60;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
}

/* üîπ Novo c√°lculo de TRABALHO com intervalo:
   - base = fim - in√≠cio
   - se o intervalo (in√≠cioIntervalo e fimIntervalo) estiver DENTRO desse per√≠odo -> desconta 1h
   - se estiver antes do in√≠cio ou depois do fim -> n√£o desconta nada
*/
function computeTrabalho(h){
  if(!h) return null;
  const inicioStr=h.inicio;
  const fimStr=h.fim;
  const base=diffMinutes(inicioStr,fimStr);
  if(base==null) return null;

  const inicioMin=parseTimeToMinutes(inicioStr);
  const fimMin=parseTimeToMinutes(fimStr);
  const iniInt=parseTimeToMinutes(h.inicioIntervalo);
  const fimInt=parseTimeToMinutes(h.fimIntervalo);

  if(
    iniInt!=null && fimInt!=null &&
    inicioMin!=null && fimMin!=null &&
    iniInt>=inicioMin && fimInt<=fimMin
  ){
    const ajustado = base - 60; // desconta 1h fixo
    return ajustado>0 ? ajustado : 0;
  }
  return base;
}

/* ===== Plugin p/ valores nas barras/pontos ===== */
const valueLabelPlugin = {
  id:'valueLabelPlugin',
  afterDatasetsDraw(chart){
    const {ctx}=chart;
    ctx.save();
    chart.data.datasets.forEach((dataset,i)=>{
      const meta=chart.getDatasetMeta(i);
      if(meta.hidden) return;
      meta.data.forEach((element,index)=>{
        const value=dataset.data[index];
        if(value==null || value===0) return;

        let text;
        // üîπ Para o gr√°fico de tempo por caminh√£o, mostrar HH:MM
        if(chart.canvas && chart.canvas.id==="chartTempoCaminhao"){
          text = formatMinutesAsHhMm(value);
        }else{
          text = value.toString();
        }

        ctx.font='10px "Inter",sans-serif';
        ctx.fillStyle='#f9fafb';
        ctx.textAlign='center';
        ctx.textBaseline='middle';
        let {x,y}=element.getProps(['x','y'],true);

        if(chart.config.type==='line'){
          y-=10;
        }else if(chart.config.type==='bar'){
          if(chart.options.indexAxis==='y'){
            x-=10; ctx.textAlign='right';
          }else{
            y+=10;
          }
        }
        ctx.fillText(text,x,y);
      });
    });
    ctx.restore();
  }
};
Chart.register(valueLabelPlugin);

/* ===== Multi-select de locais (estilo Excel) ===== */
btnLocal.addEventListener("click",(e)=>{
  e.stopPropagation();
  panelLocal.classList.toggle("open");
});
panelLocal.addEventListener("click",e=>e.stopPropagation());
window.addEventListener("click",()=>panelLocal.classList.remove("open"));

function renderLocaisFilter(){
  panelLocalList.innerHTML="";
  if(locaisDisponiveis.length===0){
    panelLocalList.innerHTML='<div style="font-size:.8rem;color:var(--muted);">Nenhum local cadastrado ainda.</div>';
    return;
  }
  locaisDisponiveis.forEach(loc=>{
    const opt=document.createElement("label");
    opt.className="multi-option";
    const checked = locaisSelecionados.size===0 || locaisSelecionados.has(loc);
    opt.innerHTML = `
      <input type="checkbox" ${checked?"checked":""} data-value="${loc}">
      <span>${loc}</span>
    `;
    panelLocalList.appendChild(opt);
  });
}

applyLocalBtn.addEventListener("click",()=>{
  const checks=panelLocalList.querySelectorAll('input[type="checkbox"]');
  const novos=new Set();
  checks.forEach(ch=>{
    if(ch.checked) novos.add(ch.dataset.value);
  });
  // se todos estiverem selecionados ou nenhum -> consideramos "todos" (set vazio)
  if(novos.size===0 || novos.size===locaisDisponiveis.length){
    locaisSelecionados = new Set();
    btnLocalText.textContent="Todos os locais";
  }else{
    locaisSelecionados = novos;
    btnLocalText.textContent = `${novos.size} selecionado(s)`;
  }
  panelLocal.classList.remove("open");
  aplicaFiltros();
});

/* ===== Filtro por m√™s ===== */
filtroMesEl.addEventListener("change",aplicaFiltros);

/* ===== Aplicar filtros ===== */
function aplicaFiltros(){
  const mes=filtroMesEl.value;

  filtrados = relatorios.filter(r=>{
    if(r.data){
      const ds=String(r.data);
      const m=ds.slice(5,7);
      if(mes && m!==mes) return false;
    }
    // filtro por locais
    if(locaisSelecionados.size>0){
      const loc=(r.local||"").trim();
      if(!locaisSelecionados.has(loc)) return false;
    }
    return true;
  });

  // üîπ Removido texto "M√™s: todos ‚Äî X atividades"
  tagPeriodo.textContent = "";

  atualizarKpisECharts();
}

/* ===== KPIs + gr√°ficos ===== */
function atualizarKpisECharts(){
  const total=filtrados.length;
  kpiAtividades.textContent=total;

  if(total===0){
    kpiTrabalhando.textContent="00:00";
    kpiDDS.textContent="00:00";
    kpiEspera.textContent="00:00";
    miniSummaryEl.textContent="Sem dados para exibir. Ajuste os filtros.";
    atualizarGraficos({labels:[],data:[]},{labels:[],data:[]},{labels:[],data:[]});
    return;
  }

  let totalTrabalho=0, totalDDS=0, totalEspera=0;

  filtrados.forEach(r=>{
    const h=r.horarios||{};

    // üîπ Novo c√°lculo de tempo trabalhado (com regra do intervalo)
    const dTrab=computeTrabalho(h);
    if(dTrab!=null) totalTrabalho+=dTrab;

    const ddds=diffMinutes(h.ddsChecklist,h.disposicao);
    if(ddds!=null) totalDDS+=ddds;

    const desp=diffMinutes(h.chegada,h.liberacaoPT);
    if(desp!=null) totalEspera+=desp;
  });

  // üîπ KPIs em HH:MM
  kpiTrabalhando.textContent=formatMinutesAsHhMm(totalTrabalho);
  kpiDDS.textContent=formatMinutesAsHhMm(totalDDS);
  kpiEspera.textContent=formatMinutesAsHhMm(totalEspera);

  // üîπ Removida frase "Trabalho: ... DDS ..." no rodap√©
  miniSummaryEl.textContent = "";

  const mapArea=new Map();
  const mapCaminhaoCount=new Map();
  const mapCaminhaoTempo=new Map();

  filtrados.forEach(r=>{
    const area=(r.local||"Sem local").trim()||"Sem local";
    mapArea.set(area,(mapArea.get(area)||0)+1);

    const placa=(r.placa||"Sem placa").trim()||"Sem placa";
    mapCaminhaoCount.set(placa,(mapCaminhaoCount.get(placa)||0)+1);

    const h=r.horarios||{};
    const dTrab=computeTrabalho(h);
    if(dTrab!=null){
      // üîπ Guarda MINUTOS para depois formatar como HH:MM no gr√°fico
      mapCaminhaoTempo.set(placa,(mapCaminhaoTempo.get(placa)||0)+dTrab);
    }
  });

  const arrArea=Array.from(mapArea.entries()).sort((a,b)=>b[1]-a[1]).slice(0,25);
  const labelsArea=arrArea.map(e=>e[0]);
  const dataArea=arrArea.map(e=>e[1]);

  const arrCamCount=Array.from(mapCaminhaoCount.entries()).sort((a,b)=>b[1]-a[1]);
  const labelsCamCount=arrCamCount.map(e=>e[0]);
  const dataCamCount=arrCamCount.map(e=>e[1]);

  const arrCamTempo=Array.from(mapCaminhaoTempo.entries()).sort((a,b)=>b[1]-a[1]);
  const labelsCamTempo=arrCamTempo.map(e=>e[0]);
  const dataCamTempo=arrCamTempo.map(e=>e[1]); // minutos

  atualizarGraficos(
    {labels:labelsArea,data:dataArea},
    {labels:labelsCamCount,data:dataCamCount},
    {labels:labelsCamTempo,data:dataCamTempo}
  );
}

/* ===== Gr√°ficos ===== */
function atualizarGraficos(areaAgg,camCountAgg,camTempoAgg){
  const ctxArea=document.getElementById("chartArea").getContext("2d");
  const ctxCam=document.getElementById("chartCaminhao").getContext("2d");
  const ctxTempo=document.getElementById("chartTempoCaminhao").getContext("2d");

  if(chartArea) chartArea.destroy();
  if(chartCaminhao) chartCaminhao.destroy();
  if(chartTempoCaminhao) chartTempoCaminhao.destroy();

  const azul="rgba(37,99,235,0.9)";
  const azulBar="rgba(37,99,235,0.85)";

  // TOPO: √ÅREAS (barras verticais)
  chartArea=new Chart(ctxArea,{
    type:"bar",
    data:{
      labels:areaAgg.labels||[],
      datasets:[{
        data:areaAgg.data||[],
        backgroundColor:azulBar,
        borderRadius:4,
        maxBarThickness:20
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{enabled:false}},
      scales:{
        x:{
          grid:{display:false},
          border:{display:false},
          ticks:{autoSkip:false,maxRotation:60,minRotation:30,font:{size:10}}
        },
        y:{
          beginAtZero:true,
          grid:{display:false},
          border:{display:false},
          ticks:{display:false}
        }
      }
    }
  });

  // BAIXO DIREITA: ATIVIDADES POR CAMINH√ÉO (barras horizontais)
  chartCaminhao=new Chart(ctxCam,{
    type:"bar",
    data:{
      labels:camCountAgg.labels||[],
      datasets:[{
        data:camCountAgg.data||[],
        backgroundColor:azulBar,
        borderRadius:4,
        maxBarThickness:20
      }]
    },
    options:{
      indexAxis:"y",
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{enabled:false}},
      scales:{
        x:{
          beginAtZero:true,
          grid:{display:false},
          border:{display:false},
          ticks:{display:false}
        },
        y:{
          grid:{display:false},
          border:{display:false},
          ticks:{font:{size:10}}
        }
      }
    }
  });

  // BAIXO ESQUERDA: TEMPO POR CAMINH√ÉO (√°rea, dados em minutos)
  const grad=ctxTempo.createLinearGradient(0,0,0,200);
  grad.addColorStop(0,"rgba(37,99,235,0.7)");
  grad.addColorStop(1,"rgba(37,99,235,0.05)");

  chartTempoCaminhao=new Chart(ctxTempo,{
    type:"line",
    data:{
      labels:camTempoAgg.labels||[],
      datasets:[{
        data:camTempoAgg.data||[], // minutos
        fill:true,
        backgroundColor:grad,
        borderColor:azul,
        borderWidth:2,
        pointRadius:4,
        pointBackgroundColor:azul,
        tension:0.35
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{enabled:false}},
      scales:{
        x:{
          grid:{display:false},
          border:{display:false},
          ticks:{font:{size:10}}
        },
        y:{
          beginAtZero:true,
          grid:{display:false},
          border:{display:false},
          ticks:{display:false}
        }
      }
    }
  });
}

/* ===== Carregar relat√≥rios do Firebase ===== */
async function carregarRelatorios(){
  try{
    miniSummaryEl.textContent="Carregando dados do Firebase...";
    const snap=await db.collection("relatoriosCampo").orderBy("data","asc").get();
    relatorios=snap.docs.map(doc=>({id:doc.id,...doc.data()}));

    // montar lista de locais para o filtro
    const setLocais=new Set();
    relatorios.forEach(r=>{
      if(r.local){
        setLocais.add(r.local.trim());
      }
    });
    locaisDisponiveis=Array.from(setLocais).sort((a,b)=>a.localeCompare(b));
    renderLocaisFilter();

    miniSummaryEl.textContent="Carregando estat√≠sticas...";
    aplicaFiltros();
  }catch(err){
    console.error("Erro ao carregar relat√≥rios:",err);
    miniSummaryEl.textContent="Erro ao carregar dados. Veja o console.";
  }
}

carregarRelatorios();
</script>

</body>
</html>
