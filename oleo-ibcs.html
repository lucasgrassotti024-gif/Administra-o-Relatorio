<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Planilha ‚Äî √ìleo descartado em IBCs</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Outfit:wght@600;800&display=swap" rel="stylesheet">

<style>
:root {
  --primary:#2563eb;
  --accent:#1d4ed8;
  --bg:#f3f6fb;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --shadow-soft:0 10px 30px rgba(15,23,42,0.10);
  --shadow-hard:0 18px 45px rgba(15,23,42,0.20);

  --sidebar-bg:#ffffff;
  --sidebar-text:#111827;
  --sidebar-link:#111827;

  --table-header-bg:rgba(37,99,235,0.06);
  --table-header-border:#cbd5f5;
  --table-row-alt:rgba(15,23,42,0.015);
}
.dark {
  --bg:#020617;
  --card:#020617;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --border:#111827;
  --shadow-soft:0 10px 30px rgba(0,0,0,0.60);
  --shadow-hard:0 18px 45px rgba(0,0,0,0.80);

  --sidebar-bg:#020617;
  --sidebar-text:#e5e7eb;
  --sidebar-link:#e5e7eb;

  --table-header-bg:rgba(15,23,42,0.92);
  --table-header-border:#1e293b;
  --table-row-alt:rgba(15,23,42,0.45);
}

*{
  box-sizing:border-box;
  font-family:"Inter",sans-serif;
  transition:background-color .25s ease,color .25s ease,border-color .25s ease;
}

/* FUNDO */
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  display:flex;
}

/* SIDEBAR */
.sidebar{
  width:230px;
  background:var(--sidebar-bg);
  color:var(--sidebar-text);
  display:flex;
  flex-direction:column;
  padding:14px 12px;
  gap:14px;
  position:fixed;
  inset-block:0;
  left:0;
  z-index:40;
  box-shadow:var(--shadow-hard);
  transform:translateX(-100%);
  transition:transform .25s ease, background-color .25s ease, color .25s ease;
}
body.sidebar-open .sidebar{
  transform:translateX(0);
}
.sidebar-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.sidebar-title-block{
  display:flex;
  flex-direction:column;
}
.sidebar-title{
  font-family:"Outfit";
  font-weight:800;
  font-size:1.0rem;
}
.sidebar-sub{
  font-size:.72rem;
  color:var(--muted);
}
.sidebar-toggle-theme{
  width:32px;
  height:32px;
  border-radius:50%;
  border:1px solid rgba(148,163,184,0.5);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  background:transparent;
  font-size:1rem;
  color:var(--sidebar-text);
}
.sidebar-nav{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.sidebar-link{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 9px;
  border-radius:10px;
  text-decoration:none;
  font-size:.85rem;
  color:var(--sidebar-link);
  cursor:pointer;
}
.sidebar-link span.icon{width:18px;text-align:center;}
.sidebar-link:hover,
.sidebar-link.active{
  background:rgba(37,99,235,0.15);
}
.sidebar-footer{
  margin-top:auto;
  font-size:.7rem;
  color:var(--muted);
  border-top:1px solid rgba(148,163,184,0.3);
  padding-top:8px;
}

/* BOT√ÉO FLOANTE SIDEBAR */
.sidebar-handle{
  position:fixed;
  top:14px;
  left:10px;
  z-index:45;
  width:30px;
  height:30px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  background:#2563eb;
  color:#f9fafb;
  box-shadow:0 8px 20px rgba(37,99,235,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.1rem;
}

/* MAIN WRAPPER */
.main-wrapper{
  flex:1;
  min-height:100vh;
  padding:18px 20px 24px;
  display:flex;
  flex-direction:column;
}
@media(max-width:900px){
  .main-wrapper{
    padding-top:56px;
  }
}

/* TOPBAR MOBILE */
.topbar-mobile{
  position:fixed;
  top:0;left:0;right:0;
  height:48px;
  background:var(--sidebar-bg);
  color:var(--sidebar-text);
  display:flex;
  align-items:center;
  justify-content:center;
  font-family:"Outfit";
  font-weight:700;
  font-size:.9rem;
  z-index:30;
}
@media(min-width:901px){
  .topbar-mobile{display:none;}
}

/* HEADER */
.page-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:12px;
  margin-bottom:10px;
}
.page-title{
  font-family:"Outfit";
  font-weight:800;
  font-size:1.4rem;
}
.page-sub{
  font-size:.8rem;
  color:var(--muted);
}

/* A√á√ïES / RESUMO */
.table-actions{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:8px;
  margin-bottom:4px;
  align-items:center;
}

/* Card de resumo */
.stats-card{
  background:var(--card);
  border-radius:14px;
  padding:10px 14px;
  box-shadow:var(--shadow-soft);
  border:1px solid var(--table-header-border);
  display:flex;
  flex-direction:column;
  min-width:220px;
}
.stats-title{
  font-size:.8rem;
  font-weight:600;
  color:var(--muted);
  margin-bottom:4px;
}
/* Removemos o texto, mas mantemos o espa√ßamento se quiser */
.stats-title::before{
  content:"";
}
.stats-row{
  display:flex;
  gap:14px;
  align-items:baseline;
}
.stats-big{
  font-size:1.2rem;
  font-weight:800;
  color:var(--primary);
}
.stats-label{
  font-size:.8rem;
  color:var(--muted);
}

/* Filtro m√™s */
.filter-mes{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:.8rem;
}
.filter-mes select{
  padding:6px 9px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--card);
  font-size:.8rem;
  color:var(--text);
}

/* WRAPPER DA TABELA (drag-scroll) */
.table-wrapper{
  margin-top:12px;
  background:var(--card);
  border-radius:18px;
  box-shadow:var(--shadow-soft);
  border:1px solid var(--table-header-border);
  padding:12px;
  overflow:auto;
  cursor:grab;
}
.table-wrapper.dragging{
  cursor:grabbing;
}

/* TABELA */
table{
  border-collapse:collapse;
  min-width:900px;
  background:var(--card);
}
thead{
  position:sticky;
  top:0;
  z-index:5;
  background:var(--table-header-bg);
  box-shadow:0 2px 4px rgba(15,23,42,0.08);
}
th,td{
  border:1px solid var(--border);
  padding:6px 8px;
  font-size:.8rem;
  white-space:nowrap;
}
th{
  background:var(--table-header-bg);
  border-bottom:1px solid var(--table-header-border);
  font-weight:700;
  text-align:left;
}

/* LINHAS ZEBRADAS + HOVER */
tbody tr:nth-child(even){
  background:var(--table-row-alt);
}
tbody tr:hover{
  background:rgba(37,99,235,0.06);
}

/* RODAP√â */
footer{
  margin-top:10px;
  font-size:.75rem;
  color:var(--muted);
  text-align:center;
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-title-block">
      <span class="sidebar-title">Relat√≥rios de Campo</span>
      <span class="sidebar-sub">CMPC ‚Ä¢ RSS3</span>
    </div>
    <button id="themeToggle" class="sidebar-toggle-theme" type="button">üåô</button>
  </div>

  <nav class="sidebar-nav">
    <a href="admin.html" class="sidebar-link">
      <span class="icon">üìã</span><span>Admin</span>
    </a>
    <a href="dashboard.html" class="sidebar-link">
      <span class="icon">üìä</span><span>Dashboard</span>
    </a>
    <a href="planilha.html" class="sidebar-link">
      <span class="icon">üìë</span><span>Planilha</span>
    </a>
    <a href="oleo-ibcs.html" class="sidebar-link active">
      <span class="icon">üõ¢Ô∏è</span><span>√ìleo em IBCs</span>
    </a>
    <a href="excluidos.html" class="sidebar-link">
      <span class="icon">üóëÔ∏è</span><span>Exclu√≠dos</span>
    </a>
  </nav>

  <div class="sidebar-footer">
    Planilha de √≥leo<br>Descartado em IBCs.
  </div>
</aside>

<button id="sidebarHandle" class="sidebar-handle" type="button">‚ò∞</button>

<div class="topbar-mobile">Planilha ‚Äî √ìleo em IBCs</div>

<!-- MAIN -->
<div class="main-wrapper">
  <header class="page-header">
    <div>
      <div class="page-title">Planilha ‚Äî √ìleo em IBCs</div>
      <!-- Mantemos o elemento, mas n√£o mostraremos mais contagem final -->
      <div class="page-sub" id="subtitleInfo">Carregando dados...</div>
    </div>
  </header>

  <!-- RESUMO + FILTRO -->
  <div class="table-actions">
    <div class="stats-card">
      <!-- T√≠tulo removido (sem texto) -->
      <div class="stats-title"></div>
      <div class="stats-row">
        <div>
          <div class="stats-big" id="statsLitros">0</div>
          <div class="stats-label">Litros de √≥leo</div>
        </div>
        <div>
          <div class="stats-big" id="statsAtividades">0</div>
          <div class="stats-label">Atividades</div>
        </div>
      </div>
    </div>

    <div class="filter-mes">
      <span>M√™s:</span>
      <select id="filtroMes">
        <option value="">Todos</option>
        <option value="01">Jan</option>
        <option value="02">Fev</option>
        <option value="03">Mar</option>
        <option value="04">Abr</option>
        <option value="05">Mai</option>
        <option value="06">Jun</option>
        <option value="07">Jul</option>
        <option value="08">Ago</option>
        <option value="09">Set</option>
        <option value="10">Out</option>
        <option value="11">Nov</option>
        <option value="12">Dez</option>
      </select>
    </div>
  </div>

  <div class="table-wrapper" id="tableWrapper">
    <table id="sheetTable">
      <thead>
        <tr id="sheetHeaderRow"></tr>
      </thead>
      <tbody id="sheetBody"></tbody>
    </table>
  </div>

  <footer>
    ¬© 2025 | Relat√≥rios de Campo ‚Äî √ìleo em IBCs
  </footer>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCxI5gx0LS0ny2y6UnPUCyW0zf1BjnTSco",
  authDomain: "checklist-rss3.firebaseapp.com",
  projectId: "checklist-rss3",
  storageBucket: "checklist-rss3.appspot.com",
  messagingSenderId: "179261205524",
  appId: "1:179261205524:web:376152c3b94fb115f14b01",
  measurementId: "G-47CPMQ3ZTC"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<script>
// Prote√ß√£o b√°sica (mesmo esquema)
if(localStorage.getItem("auth_relatorios")!=="true"){
  // window.location.href="index.html";
}

/* Tema */
const themeToggle=document.getElementById("themeToggle");
if(localStorage.getItem("tema")==="dark"){
  document.body.classList.add("dark");
  themeToggle.textContent="‚òÄÔ∏è";
}
themeToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  const dark=document.body.classList.contains("dark");
  themeToggle.textContent=dark?"‚òÄÔ∏è":"üåô";
  localStorage.setItem("tema",dark?"dark":"light");
};

/* Sidebar */
const sidebarHandle=document.getElementById("sidebarHandle");
sidebarHandle.addEventListener("click",()=>{
  document.body.classList.toggle("sidebar-open");
});
</script>

<script>
const tableWrapper=document.getElementById("tableWrapper");
const sheetHeaderRow=document.getElementById("sheetHeaderRow");
const sheetBody=document.getElementById("sheetBody");
const subtitleInfo=document.getElementById("subtitleInfo");
const filtroMes=document.getElementById("filtroMes");
const statsLitros=document.getElementById("statsLitros");
const statsAtividades=document.getElementById("statsAtividades");

// drag-scroll horizontal
let isDown=false,startX,scrollLeft;
tableWrapper.addEventListener("mousedown",(e)=>{
  isDown=true;
  tableWrapper.classList.add("dragging");
  startX=e.pageX - tableWrapper.offsetLeft;
  scrollLeft=tableWrapper.scrollLeft;
});
tableWrapper.addEventListener("mouseleave",()=>{isDown=false;tableWrapper.classList.remove("dragging");});
tableWrapper.addEventListener("mouseup",()=>{isDown=false;tableWrapper.classList.remove("dragging");});
tableWrapper.addEventListener("mousemove",(e)=>{
  if(!isDown) return;
  e.preventDefault();
  const x=e.pageX - tableWrapper.offsetLeft;
  const walk=x-startX;
  tableWrapper.scrollLeft = scrollLeft - walk;
});

// touch
tableWrapper.addEventListener("touchstart",(e)=>{
  isDown=true;
  tableWrapper.classList.add("dragging");
  startX=e.touches[0].pageX - tableWrapper.offsetLeft;
  scrollLeft=tableWrapper.scrollLeft;
},{passive:true});
tableWrapper.addEventListener("touchend",()=>{isDown=false;tableWrapper.classList.remove("dragging");});
tableWrapper.addEventListener("touchmove",(e)=>{
  if(!isDown) return;
  const x=e.touches[0].pageX - tableWrapper.offsetLeft;
  const walk=x-startX;
  tableWrapper.scrollLeft = scrollLeft - walk;
},{passive:true});

/* ===== Colunas da planilha de √≥leo em IBCs ===== */
const columns=[
  {key:"numeroPT",            label:"N¬∫ PT"},
  {key:"data",                label:"Data"},
  {key:"diaSemana",           label:"Dia Semana"},
  {key:"equipamento",         label:"Equipamento"},
  {key:"placa",               label:"Placa"},
  {key:"local",               label:"Local"},
  {key:"tipoServico",         label:"Tipo Servi√ßo"},
  {key:"quantidade",          label:"Qtd (texto)"},
  {key:"litros",              label:"Litros (calc.)"},
  {key:"ondeDescartadoTexto", label:"Descartado em"},
  {key:"operador",            label:"Operador"},
  {key:"ajudante",            label:"Ajudante"}
];

let relatoriosAll=[];
let relatoriosFiltrados=[];

/* ===== Util: converte quantidade em litros =====
   Regras:
   - Se tiver "IBC" no texto -> interpreta n√∫mero como quantidade de IBCs (1 IBC = 1000 L)
   - Caso contr√°rio, pega o n√∫mero e assume que √© litros direto (ex.: "500 L" -> 500)
*/
function quantidadeToLitros(q){
  if(!q) return 0;
  const txt=String(q).trim();
  if(!txt) return 0;
  const lower=txt.toLowerCase();

  // extrai primeiro n√∫mero do texto
  const match = lower.match(/[\d.,]+/);
  if(!match) return 0;
  let numStr=match[0].replace(/\./g,"").replace(",",".");
  let valor=parseFloat(numStr);
  if(isNaN(valor) || valor<=0) return 0;

  if(lower.includes("ibc")){
    // trata como quantidade de IBCs
    return valor*1000;
  }
  // trata como litros diretamente
  return valor;
}

/* ===== Cabe√ßalho ===== */
function renderHeader(){
  sheetHeaderRow.innerHTML="";
  columns.forEach(col=>{
    const th=document.createElement("th");
    th.textContent=col.label;
    sheetHeaderRow.appendChild(th);
  });
}

/* ===== Corpo ===== */
function renderBody(){
  sheetBody.innerHTML="";
  relatoriosFiltrados.forEach(r=>{
    const tr=document.createElement("tr");
    columns.forEach(col=>{
      const td=document.createElement("td");
      let val=r[col.key];

      if(col.key==="data" && r.data){
        // data no formato YYYY-MM-DD -> DD/MM/YYYY
        if(typeof r.data==="string" && r.data.includes("-")){
          const [y,m,d]=r.data.split("-");
          val = `${d}/${m}/${y}`;
        }
      }

      if(col.key==="litros"){
        val = r.litros > 0
          ? r.litros.toLocaleString("pt-BR",{minimumFractionDigits:0, maximumFractionDigits:0})
          : "";
      }

      if(val==null) val="";
      td.textContent=String(val);
      tr.appendChild(td);
    });
    sheetBody.appendChild(tr);
  });
}

/* ===== Atualiza resumo (card) ===== */
function atualizarResumo(){
  const totalAtividades = relatoriosFiltrados.length;
  let totalLitros = 0;
  relatoriosFiltrados.forEach(r=>{
    totalLitros += r.litros || 0;
  });

  statsAtividades.textContent = totalAtividades;
  statsLitros.textContent = totalLitros.toLocaleString("pt-BR",{
    minimumFractionDigits:0,
    maximumFractionDigits:0
  });

  // N√£o mostramos mais a frase "X atividade(s)..." abaixo do t√≠tulo
}

/* ===== Filtro por m√™s ===== */
function aplicarFiltros(){
  const mes=filtroMes.value; // "01".."12" ou ""

  relatoriosFiltrados = relatoriosAll.filter(r=>{
    if(!mes) return true;
    if(!r.data) return false;
    const m = String(r.data).slice(5,7);
    return m===mes;
  });

  renderBody();
  atualizarResumo();
}

filtroMes.addEventListener("change",aplicarFiltros);

/* ===== Carregar relat√≥rios ===== */
async function carregarRelatorios(){
  try{
    subtitleInfo.textContent="Carregando dados do Firebase...";
    const snap=await db.collection("relatoriosCampo").orderBy("numeroPT","desc").get();

    relatoriosAll=[];

    snap.docs.forEach(doc=>{
      const d = doc.data();
      const e = d.especificacoes || {};

      const oleoVal   = e.oleo || d.oleo || "";
      const tipoAtiv  = e.tipoAtividade || d.tipoAtividade || "";
      const ondeTipo  = e.ondeDescartadoTipo || "";
      const ondeTexto = e.ondeDescartadoTexto || "";

      // Filtra apenas:
      // - √ìleo = "Sim"
      // - Tipo = "Descarte"
      // - OndeDescartadoTipo = "IBCs"
      if(oleoVal !== "Sim") return;
      if(tipoAtiv !== "Descarte") return;
      if(ondeTipo !== "IBCs") return;

      const qtdTexto = e.quantidade || d.quantidade || "";
      const litrosCalc = quantidadeToLitros(qtdTexto);

      relatoriosAll.push({
        id: doc.id,
        numeroPT: d.numeroPT ?? d.numeroPt ?? "",
        data: d.data || "",
        diaSemana: d.diaSemana || "",
        equipamento: d.equipamento || "",
        placa: d.placa || "",
        local: d.local || "",
        tipoServico: d.tipoServico || e.tipoServico || "",
        quantidade: qtdTexto,
        litros: litrosCalc,
        ondeDescartadoTexto: ondeTexto || "IBCs",
        operador: d.operador || "",
        ajudante: d.ajudante || ""
      });
    });

    renderHeader();
    relatoriosFiltrados=[...relatoriosAll];
    renderBody();
    atualizarResumo();

    // Depois de carregar tudo com sucesso, limpamos o texto abaixo do t√≠tulo
    subtitleInfo.textContent = "";
  }catch(err){
    console.error("Erro ao carregar relat√≥rios:",err);
    subtitleInfo.textContent="Erro ao carregar dados. Veja o console.";
  }
}

carregarRelatorios();
</script>

</body>
</html>
